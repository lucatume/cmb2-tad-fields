define(["./core","./var/slice","./callbacks"],function(a,b){a.extend({Deferred:function(e){var d=[["resolve","done",a.Callbacks("once memory"),"resolved"],["reject","fail",a.Callbacks("once memory"),"rejected"],["notify","progress",a.Callbacks("memory")]],f="pending",g={state:function(){return f},always:function(){c.done(arguments).fail(arguments);return this},then:function(){var h=arguments;return a.Deferred(function(i){a.each(d,function(k,j){var l=a.isFunction(h[k])&&h[k];c[j[1]](function(){var m=l&&l.apply(this,arguments);if(m&&a.isFunction(m.promise)){m.promise().done(i.resolve).fail(i.reject).progress(i.notify)}else{i[j[0]+"With"](this===g?i.promise():this,l?[m]:arguments)}})});h=null}).promise()},promise:function(h){return h!=null?a.extend(h,g):g}},c={};g.pipe=g.then;a.each(d,function(j,h){var l=h[2],k=h[3];g[h[1]]=l.add;if(k){l.add(function(){f=k},d[j^1][2].disable,d[2][2].lock)}c[h[0]]=function(){c[h[0]+"With"](this===c?g:this,arguments);return this};c[h[0]+"With"]=l.fireWith});g.promise(c);if(e){e.call(c,c)}return c},when:function(g){var e=0,j=b.call(arguments),c=j.length,d=c!==1||(g&&a.isFunction(g.promise))?c:0,m=d===1?g:a.Deferred(),f=function(o,p,n){return function(i){p[o]=this;n[o]=arguments.length>1?b.call(arguments):i;if(n===l){m.notifyWith(p,n)}else{if(!(--d)){m.resolveWith(p,n)}}}},l,h,k;if(c>1){l=new Array(c);h=new Array(c);k=new Array(c);for(;e<c;e++){if(j[e]&&a.isFunction(j[e].promise)){j[e].promise().done(f(e,k,j)).fail(m.reject).progress(f(e,h,l))}else{--d}}}if(!d){m.resolveWith(k,j)}return m.promise()}});return a});